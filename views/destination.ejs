<%- include("templates/header") %>

    <div class="grid w-5/6 h-full mx-auto mt-4">
        <% if (location && location.data && location.data.length> 0) { %>
            <h1 class="text-center text-2xl font-bold mb-4">
                <%= location.city %>
            </h1>
            <img src="<%= location.imageUrl %>" alt="location image"
                class="max-h-72 w-full max border-2 border-orange-400 rounded-3xl">
            <p id="name_goes_here" class="text-center h1">
                <span class="border-b-4 border-purple-600">
                    <%= location.name %>
                </span>
            </p>
            <div class="mx-auto flex justify-center w-4/5 mt-2">
                <span style="margin-right: 16px;">Rating: <%= location.rating %>
                        <% var fullStars=Math.floor(location.rating); var halfStars=location.rating % 1>= 0.5 ? 1 : 0;
                            var emptyStars = 5 - fullStars - halfStars;
                            %>
                            <% for (var i=0; i < fullStars; i++) { %>
                                <i style="margin-right: -6px;" class="fa-solid fa-star"></i>
                                <% } %>
                                    <% if (halfStars) { %>
                                        <i style="margin-right: -6px;" class="fa-solid fa-star-half-stroke"></i>
                                        <% } %>
                                            <% for (var i=0; i < emptyStars; i++) { %>
                                                <i style="margin-right: -6px;" class="fa-regular fa-star"></i>
                                                <% } %>
                </span>
                <button
                    class="ml-auto text-2xl pb-1 text-white border-2 border-teal-400 bg-teal-300 rounded-lg px-10 hover:border-cyan-300 hover:bg-cyan-200"
                    id="reviewBtn" onclick='window.location.href="/review?location=<%= location.name %>"'>
                    Reviews
                </button>
                <button
                    class="ml-auto text-2xl pb-1 text-white border-2 border-teal-400 bg-teal-300 rounded-lg px-10 hover:border-cyan-300 hover:bg-cyan-200"
                    id="reviewBtn" onclick='window.location.href="/weather?email=<%= email %>"'>
                    Back
                </button>
                <button class="ml-4 mr-auto" onclick="saveLocation('<%= location.name %>')">
                    <% if (bookmark) { %><i class="fa-solid fa-bookmark"></i>
                        <% } else { %><i class="fa-regular fa-bookmark"></i>
                            <% } %>
                </button>
            </div>
            <div id="map" class="w-full h-96 my-4"></div>
            <script>
                function initMap() {
                    const map = new google.maps.Map(document.getElementById("map"), {
                        zoom: 8,
                        center: { lat: 49.2827, lng: -123.1207 } // Default to Vancouver
                    });

                    const weatherData = <%= JSON.stringify(location.data) %>;
                    const city = "<%= location.city %>";

                    let infowindow = new google.maps.InfoWindow();

                    weatherData.forEach((day, index) => {
                        const marker = new google.maps.Marker({
                            position: { lat: 49.2827, lng: -123.1207 }, // Replace with dynamic lat/lng for each city
                            map: map,
                            title: city
                        });

                        marker.addListener("click", () => {
                            infowindow.setContent(`
                            <div>
                                <h3>${city}</h3>
                                <p>Date: ${day.datetime}</p>
                                <p>Temperature: ${day.temp}°C</p>
                                <p>Max Temp: ${day.tempmax}°C</p>
                                <p>Min Temp: ${day.tempmin}°C</p>
                                <p>Conditions: ${day.conditions}</p>
                                <p>Humidity: ${day.humidity}%</p>
                            </div>
                            <div>
                                <button onclick="showPrevious(${index})">Previous</button>
                                <button onclick="showNext(${index})">Next</button>
                            </div>
                        `);
                            infowindow.open(map, marker);
                        });
                    });

                    let currentIndex = 0;

                    function showPrevious(index) {
                        currentIndex = index > 0 ? index - 1 : weatherData.length - 1;
                        updateInfowindow();
                    }

                    function showNext(index) {
                        currentIndex = index < weatherData.length - 1 ? index + 1 : 0;
                        updateInfowindow();
                    }

                    function updateInfowindow() {
                        const day = weatherData[currentIndex];
                        infowindow.setContent(`
                        <div>
                            <h3>${city}</h3>
                            <p>Date: ${day.datetime}</p>
                            <p>Temperature: ${day.temp}°C</p>
                            <p>Max Temp: ${day.tempmax}°C</p>
                            <p>Min Temp: ${day.tempmin}°C</p>
                            <p>Conditions: ${day.conditions}</p>
                            <p>Humidity: ${day.humidity}%</p>
                        </div>
                        <div>
                            <button onclick="showPrevious(${currentIndex})">Previous</button>
                            <button onclick="showNext(${currentIndex})">Next</button>
                        </div>
                    `);
                        infowindow.open(map);
                    }
                }
            </script>
            <script async defer
                src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
            <% } else { %>
                <p class="text-center">No weather data found for the selected city and date range.</p>
                <% } %>
    </div>

    <%- include("templates/homenav") %>
        <%- include("templates/footer") %>